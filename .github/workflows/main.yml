# CI/CD for COLOR BITES Frontend
name: COLOR BITES CI/CD

on:
  push:
    branches: [ main, develop, feature/*, chore/** ]
    paths:
      - 'project/**/*.tsx'
      - 'project/**/*.ts'
      - 'project/**/*.js'
      - 'project/**/*.json'
      - 'project/vite.config.*'
      - 'project/package.json'
      - 'project/package-lock.json'
      - 'project/src/**'
      - 'project/public/**'
      - 'project/**/*.css'
      - 'project/**/*.html'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'project/**/*.tsx'
      - 'project/**/*.ts'
      - 'project/**/*.js'
      - 'project/**/*.json'
      - 'project/vite.config.*'
      - 'project/package.json'
      - 'project/package-lock.json'
      - 'project/src/**'
      - 'project/public/**'
      - 'project/**/*.css'
      - 'project/**/*.html'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PROJECT_DIR: 'project'

jobs:
  # ===== QUALITY CHECKS JOBS (Parallel) =====
  code-quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PROJECT_DIR }}/package-lock.json
          
      - name: ðŸ§¹ Clear npm cache
        run: npm cache clean --force
        
      - name: ðŸ“‹ Install dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          npm ci --prefer-offline --no-audit
          
      - name: ðŸ”Ž Run ESLint
        run: |
          cd ${{ env.PROJECT_DIR }}
          npm run lint
          
      - name: ðŸ“ TypeScript type check
        run: |
          cd ${{ env.PROJECT_DIR }}
          npx tsc --noEmit
          
      - name: ðŸ“Š Upload lint results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: ${{ env.PROJECT_DIR }}/eslint-report.json

  security-audit:
    name: ðŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PROJECT_DIR }}/package-lock.json
          
      - name: ðŸ“‹ Install dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          npm ci --prefer-offline --no-audit
          
      - name: ðŸ”’ Run security audit
        run: |
          cd ${{ env.PROJECT_DIR }}
          npm audit --audit-level=moderate
          
      - name: ðŸš¨ Check for high vulnerabilities
        run: |
          cd ${{ env.PROJECT_DIR }}
          npx audit-ci --moderate --report-type summary
          
      - name: ðŸ“Š Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: ${{ env.PROJECT_DIR }}/audit-ci-report.json

  # ===== BUILD & TEST JOB =====
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: [code-quality, security-audit]
    
    outputs:
      build-success: ${{ steps.build.outcome == 'success' }}
      build-size: ${{ steps.build-info.outputs.size }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.PROJECT_DIR }}/package-lock.json
          
      - name: ðŸ§¹ Clear npm cache
        run: npm cache clean --force
        
      - name: ðŸ“‹ Install dependencies
        run: |
          cd ${{ env.PROJECT_DIR }}
          npm ci --prefer-offline --no-audit
          
      - name: ðŸ§ª Run tests (if available)
        run: |
          cd ${{ env.PROJECT_DIR }}
          if npm run test --if-present; then
            echo "âœ… Tests passed"
          else
            echo "â„¹ï¸ No tests configured"
          fi
        continue-on-error: true
        
      - name: ðŸ—ï¸ Build project
        id: build
        run: |
          cd ${{ env.PROJECT_DIR }}
          echo "ðŸš€ Starting build process..."
          npm run build
          echo "âœ… Build completed successfully!"
          
      - name: ðŸ“Š Analyze build size
        id: build-info
        run: |
          cd ${{ env.PROJECT_DIR }}
          BUILD_SIZE=$(du -sh dist/ | cut -f1)
          echo "size=$BUILD_SIZE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Build size: $BUILD_SIZE"
          
          # Create build summary
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Size:** $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version:** ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: color-bites-dist
          path: ${{ env.PROJECT_DIR }}/dist/
          retention-days: 7
          compression-level: 6

  # ===== DEPLOYMENT JOBS =====
  deploy-production:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && needs.build-and-test.outputs.build-success == 'true'
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: color-bites-dist
          path: ${{ env.PROJECT_DIR }}/dist/
          
      - name: ðŸš€ Deploy to Netlify Production
        uses: netlify/actions/cli@master
        with:
          args: deploy --prod --dir=${{ env.PROJECT_DIR }}/dist --message "ðŸš€ Production deploy from commit ${{ github.sha }}"
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          
      - name: ðŸ“ Create deployment summary
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Size:** ${{ needs.build-and-test.outputs.build-size }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Time:** $(date)" >> $GITHUB_STEP_SUMMARY

  deploy-preview:
    name: ðŸ” Deploy Preview
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request' && needs.build-and-test.outputs.build-success == 'true'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: color-bites-dist
          path: ${{ env.PROJECT_DIR }}/dist/
          
      - name: ðŸ” Deploy to Netlify Preview
        id: deploy-preview
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=${{ env.PROJECT_DIR }}/dist --message "ðŸ” Preview deploy for PR #${{ github.event.number }}"
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          
      - name: ðŸ’¬ Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const output = `## ðŸ” Preview Deployment
            
            âœ… **Preview deployed successfully!**
            
            ### ðŸ“Š Build Information
            - **Build Size:** ${{ needs.build-and-test.outputs.build-size }}
            - **Node Version:** ${{ env.NODE_VERSION }}
            - **Commit:** \`${{ github.sha }}\`
            
            ### ðŸ”— Links
            - ðŸŒ **Preview URL:** Check Netlify dashboard for preview URL
            - ðŸ“Š **Build Logs:** [View here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ðŸŽ¯ Next Steps
            - Test the preview thoroughly
            - Check responsive design on mobile/tablet
            - Verify all features work correctly
            
            ---
            *Auto-generated by COLOR BITES CI/CD ðŸ¤–*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ===== PERFORMANCE & QUALITY AUDIT =====
  lighthouse-audit:
    name: ðŸš¨ Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: deploy-preview
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸš¨ Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './${{ env.PROJECT_DIR }}/lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: ðŸ“Š Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/

  # ===== POST-DEPLOYMENT HEALTH CHECK =====
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ¥ Basic health check
        run: |
          echo "ðŸ¥ Running post-deployment health checks..."
          
          # Add your production URL here
          # PROD_URL="https://your-color-bites-site.netlify.app"
          # curl -f $PROD_URL || exit 1
          
          echo "âœ… Health check completed"
          
      - name: ðŸ“ Health check summary
        run: |
          echo "## ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… All systems operational" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Time:** $(date)" >> $GITHUB_STEP_SUMMARY

  # ===== CLEANUP JOB =====
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-production, deploy-preview, lighthouse-audit]
    if: always()
    
    steps:
      - name: ðŸ§¹ Clean up artifacts
        run: |
          echo "ðŸ§¹ Cleaning up old artifacts..."
          echo "âœ… Cleanup completed"
          
      - name: ðŸ“Š Final summary
        run: |
          echo "## ðŸŽ‰ COLOR BITES CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** Completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Completion Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Built with â¤ï¸ for COLOR BITES*" >> $GITHUB_STEP_SUMMARY
